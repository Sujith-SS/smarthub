{% extends 'base.html' %}
{% load static %}

{% block title %}Change Password | Smarthub{% endblock %}

{% block main_content %}

<style>
    /* Custom Styles */
    body {
        background-color: #f8f9fa; /* Light background for the entire page */
    }

    .container {
        margin-top: 8em; /* Reduced margin for better positioning */
        margin-bottom: 4em;
    }

    .card {
        border-radius: 10px; /* Rounded corners for the card */
        border: none; /* Remove border */
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        padding: 2em; /* Added padding for better spacing inside the card */
    }

    .card-title {
        color: #343a40; /* Darker title color */
        font-weight: bold; /* Bold title */
        margin-bottom: 1.5em; /* Spacing below the title */
    }

    .otp-input {
        width: 50px; /* Fixed width for each OTP input */
        height: 50px; /* Fixed height for each OTP input */
        text-align: center; /* Center text in the input */
        font-size: 24px; /* Increase font size for better visibility */
        border: 1px solid #ced4da; /* Border color */
        border-radius: 5px; /* Rounded corners */
        margin: 0 5px; /* Space between inputs */
    }

    .otp-input:focus {
        border-color: #4A90E2; /* Border color on focus */
        box-shadow: 0 0 5px rgba(74, 144, 226, 0.5); /* Shadow effect on focus */
    }

    .otp-row {
        display: flex; /* Use flexbox for OTP inputs */
        justify-content: center; /* Center the inputs */
        margin: 1em 0; /* Margin for spacing */
    }

    .btn-primary {
        background-color: #ff523b; /* Custom primary button color */
        border: none; /* Remove border */
        transition: background-color 0.3s; /* Smooth transition for hover effect */
        padding: 0.75em; /* Added padding for button */
        font-size: 1.1em; /* Increased font size */
    }

    .btn-primary:hover {
        background-color: #e03e30; /* Darker shade on hover */
    }

    .link {
        color: #007bff; /* Link color */
        text-decoration: none; /* Remove underline from links */
        font-weight: bold; /* Bold link text */
    }

    .link:hover {
        text-decoration: underline; /* Underline on hover for links */
    }

    .alert {
        margin-bottom: 20px; /* Add margin below alerts */
    }

    .form-group {
        margin-bottom: 1.5em; /* Increased spacing between groups */
    }
</style>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-body">
                    <h2 class="card-title text-center">Change Password</h2>
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }}" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if not otp_verified %}
                        <div class="text-center mb-3">
                            <a href="#" class="link" id="sendOtpLink">Send OTP</a>
                        </div>
                        <hr>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="verify_otp">
                            <div class="form-group">
                                <label for="otp" class="d-block">Enter OTP</label>
                                <div class="otp-row">
                                    <input type="text" class="otp-input" id="otp1" name="otp1" maxlength="1" required>
                                    <input type="text" class="otp-input" id="otp2" name="otp2" maxlength="1" required>
                                    <input type="text" class="otp-input" id="otp3" name="otp3" maxlength="1" required>
                                    <input type="text" class="otp-input" id="otp4" name="otp4" maxlength="1" required>
                                    <input type="text" class="otp-input" id="otp5" name="otp5" maxlength="1" required>
                                    <input type="text" class="otp-input" id="otp6" name="otp6" maxlength="1" required>
                                </div>
                            </div>
                            <input type="hidden" name="otp" id="otp">
                            <button type="submit" class="btn btn-primary btn-block">Verify OTP</button>
                        </form>
                    {% else %}
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="change_password">
                            <div class="form-group">
                                <label for="new_password">New Password</label>
                                <input type="password" class="form-control" id="new_password" name="new_password" required>
                            </div>
                            <div class="form-group">
                                <label for="confirm_password">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">Change Password</button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // JavaScript to handle OTP input focusing
    document.querySelectorAll('.otp-input').forEach((input, index) => {
        input.addEventListener('input', function() {
            // Move to the next input box if the current is filled
            if (input.value.length === 1 && index < 5) {
                document.querySelectorAll('.otp-input')[index + 1].focus();
            }
            // Move to the previous input box if the current is empty and not the first box
            if (input.value.length === 0 && index > 0) {
                document.querySelectorAll('.otp-input')[index - 1].focus();
            }
            // Update hidden OTP input value
            document.getElementById('otp').value = Array.from(document.querySelectorAll('.otp-input')).map(el => el.value).join('');
        });
    });

    // Handle Send OTP link click
    document.getElementById('sendOtpLink').addEventListener('click', function(e) {
        e.preventDefault(); // Prevent the default link behavior
        const form = document.createElement('form');
        form.method = 'post';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="action" value="send_otp">
        `;
        document.body.appendChild(form);
        form.submit();
    });

    // SweetAlert for successful password change
    {% if password_changed %}
    Swal.fire({
        icon: 'success',
        title: 'Password Changed',
        text: 'Your password has been changed successfully.',
        showConfirmButton: false,
        timer: 3000
    }).then(() => {
        window.location.href = "{% url 'user_profile' %}";
    });
    {% endif %}
</script>

{% endblock %}
